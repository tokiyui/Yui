<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&#9825;小倉唯楽曲一覧&#9825;</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        .pink-cell {
            background-color: pink;
        }

        .sortable:hover {
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h2>&#9825;小倉唯楽曲一覧&#9825; <a href="tour.html">ツアーセットリスト比較ページ</a> <a href="my.html">未回収楽曲チェックツール</a> <a
            href="event.html">イベント検索ページ（ベータ版）</a></h2>
    <div class="radio-group">
        <div class="radio-button">
            <input type="radio" id="yui-solo" name="artist-filter" value="yui" checked>
            <label for="yui-solo">唯ソロ</label>

            <input type="radio" id="kaori-solo" name="artist-filter" value="kaori">
            <label for="kaori-solo">夏織ソロ</label>

            <input type="radio" id="yuikaori" name="artist-filter" value="yuikaori">
            <label for="yuikaori">ゆいかおり</label>
        </div>
    </div>
    <button id="resetOrder">元の順に戻す</button>
    <table>
        <thead>
            <tr>
                <th>楽曲名</th>
                <th>コール表</th>
                <th>MV</th>
                <th>ライブ映像</th>
                <th>披露回数 <span class="sortable" data-sort-key="count">(ソート)</span></th>
                <th>最終披露日 <span class="sortable" data-sort-key="latestDate">(ソート)</span></th>
                <th>リリース日</th>
            </tr>
        </thead>
        <tbody id="songTable"></tbody>
    </table>

    <script>
        let originalSongData = [];
        let currentSongData = [];

        function formatDateToJapanese(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}年${month}月${day}日`;
        }

        function sortTable(key) {
            currentSongData.sort((a, b) => {
                if (key === "latestDate") {
                    const dateA = a.latestDate ? new Date(a.latestDate) : new Date(0);
                    const dateB = b.latestDate ? new Date(b.latestDate) : new Date(0);
                    return dateB - dateA; // 降順
                } else {
                    return b[key] - a[key]; // 数値の降順
                }
            });
            renderTable();
        }

        function renderTable() {
            const songTable = document.getElementById("songTable");
            songTable.innerHTML = currentSongData.map(song => song.html).join("");
        }

        function updateSongDetails(selectedArtist) {
            fetch('song.json')
                .then(response => response.json())
                .then(songs => {
                    fetch('setlist.json')
                        .then(response => response.json())
                        .then(setlists => {
                            fetch('CD.json')
                                .then(response => response.json())
                                .then(CDs => {
                                    originalSongData = [];
                                    songs.forEach(song => {
                                        if (selectedArtist === "yui" && song.artist !== "小倉唯") return;
                                        if (selectedArtist === "kaori" && song.artist !== "石原夏織") return;
                                        if (selectedArtist === "yuikaori" && song.artist !== "ゆいかおり") return;

                                        const performanceData = setlists.reduce((acc, setlist) => {
                                            const date = new Date(setlist.date.replace(/年|月/g, "-").replace(/日/g, ""));
                                            const allSongs = [
                                                ...(Array.isArray(setlist.setlist) ? setlist.setlist : [setlist.setlist]),
                                                ...(Array.isArray(setlist.encore) ? setlist.encore : [setlist.encore]),
                                                ...(setlist.Wencore ? [setlist.Wencore] : [])
                                            ];
                                            if (allSongs.includes(song.title)) {
                                                acc.count++;
                                                if (!acc.latestDate || date > acc.latestDate) {
                                                    acc.latestDate = date;
                                                }
                                            }
                                            return acc;
                                        }, { count: 0, latestDate: null });

                                        const latestPerformanceDate = performanceData.latestDate
                                            ? formatDateToJapanese(performanceData.latestDate)
                                            : "未披露";

                                        const matchingCDs = CDs.filter(cd => cd.CDtitle === song.CDtitle);
                                        const releaseDate = matchingCDs.length > 0
                                            ? matchingCDs[0].date
                                            : "リリース情報なし";

                                        const rowHTML = `
                                            <tr>
                                                <td><a href="https://www.uta-net.com/song/${song.utanet}" target="_blank">${song.title}</a></td>
                                                <td>${song.call ? `<a href="https://yuicom-callbook.hatenablog.com/entry/${song.call}" target="_blank">コール表</a>` : ""}</td>
                                                <td>${song.MVlink ? `<a href="https://www.youtube.com/watch?v=${song.MVlink}" target="_blank">MV</a>` : ""}</td>
                                                <td>${song.videolink ? `<a href="https://www.youtube.com/watch?v=${song.videolink}" target="_blank">ライブ映像</a>` : ""}</td>
                                                <td>${performanceData.count}</td>
                                                <td>${latestPerformanceDate}</td>
                                                <td>${releaseDate}</td>
                                            </tr>
                                        `;
                                        originalSongData.push({
                                            ...song,
                                            count: performanceData.count,
                                            latestDate: performanceData.latestDate,
                                            html: rowHTML
                                        });
                                    });
                                    currentSongData = [...originalSongData];
                                    renderTable();
                                });
                        });
                });
        }

        document.getElementById("resetOrder").addEventListener("click", () => {
            currentSongData = [...originalSongData];
            renderTable();
        });

        document.querySelectorAll(".sortable").forEach(header => {
            header.addEventListener("click", () => {
                sortTable(header.dataset.sortKey);
            });
        });

        const artistFilters = document.getElementsByName("artist-filter");
        artistFilters.forEach(filter => {
            filter.addEventListener("change", () => {
                updateSongDetails(filter.value);
            });
        });

        updateSongDetails("yui");
    </script>
</body>

</html>
