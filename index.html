<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゆいかおり楽曲一覧</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        .pink-cell {
            background-color: hotpink;
        }

        th.sortable {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>ゆいかおり楽曲一覧 ...</h2>
    <table>
        <thead>
            <tr>
                <th>楽曲名(クリックすると歌詞が開きます)</th>
                <th>コール表</th>
                <th>MV(抜け有)</th>
                <th>ライブ映像(抜け有)</th>
                <th class="sortable" data-sort="count">披露回数</th>
                <th class="sortable" data-sort="date">最終披露日</th>
                <th>作詞</th>
                <th>作曲</th>
                <th>編曲</th>
                <th>長さ</th>
                <th>収録CD</th>
                <th>リリース日</th>
            </tr>
        </thead>
        <tbody id="songTable"></tbody>
    </table>

    <script>
        let currentSort = { key: null, order: 1 };

        function sortTable(key) {
            const songTable = document.getElementById('songTable');
            let rows = Array.from(songTable.rows);
            
            if (currentSort.key === key) {
                currentSort.order *= -1; 
            } else {
                currentSort.key = key;
                currentSort.order = 1;
            }
            
            rows.sort((a, b) => {
                let aValue = a.dataset[key];
                let bValue = b.dataset[key];
                
                if (key === "date") {
                    aValue = aValue === "未披露" ? "0000-00-00" : aValue;
                    bValue = bValue === "未披露" ? "0000-00-00" : bValue;
                }
                return (aValue > bValue ? 1 : -1) * currentSort.order;
            });
            
            songTable.innerHTML = "";
            rows.forEach(row => songTable.appendChild(row));
        }

        document.querySelectorAll("th.sortable").forEach(th => {
            th.addEventListener("click", () => sortTable(th.dataset.sort));
        });

        function updateSongDetails(selectedArtist) {
            fetch('song.json')
                .then(response => response.json())
                .then(songs => {
                    fetch('CD.json')
                        .then(response => response.json())
                        .then(CDs => {
                            fetch('setlist.json')
                                .then(response => response.json())
                                .then(setlists => {
                                    const songTable = document.getElementById('songTable');
                                    songTable.innerHTML = ''; 
                                    songs.forEach(song => {
                                        if ((selectedArtist === 'yui' && song.artist !== '小倉唯') || 
                                            (selectedArtist === 'kaori' && song.artist !== '石原夏織') || 
                                            (selectedArtist === 'yuikaori' && song.artist !== 'ゆいかおり')) return;
                                        
                                        const performanceData = setlists.reduce((acc, setlist) => {
                                            const date = new Date(setlist.date.replace(/年|月/g, '-').replace(/日/g, ''));
                                            const songsArray = Array.isArray(setlist.setlist) ? setlist.setlist : [setlist.setlist];
                                            if (!Array.isArray(setlist.encore)) songsArray.push(setlist.encore);
                                            else songsArray.push(...setlist.encore);
                                            if (setlist.Wencore) songsArray.push(setlist.Wencore);
                                            
                                            const titles = songsArray.reduce((acc, title) => {
                                                if (typeof title === 'object' && 'medley' in title) acc.push(...title.medley);
                                                else acc.push(title);
                                                return acc;
                                            }, []);
                                            
                                            if (titles.includes(song.title)) {
                                                acc.count += 1;
                                                if (!acc.latestDate || date > acc.latestDate) {
                                                    acc.latestDate = date;
                                                    acc.id = setlist.id;
                                                }
                                            }
                                            return acc;
                                        }, { count: 0, latestDate: null, id: null });
                                        
                                        const latestPerformanceDate = performanceData.latestDate 
                                            ? performanceData.latestDate.toISOString().split('T')[0] 
                                            : "未披露";

                                        const row = document.createElement("tr");
                                        row.dataset.count = performanceData.count;
                                        row.dataset.date = latestPerformanceDate;

                                        row.innerHTML = `
                                            <td><a href="https://www.uta-net.com/song/${song.utanet}">${song.title}</a></td>
                                            <td>${song.call ? `<a href="https://yuicom-callbook.hatenablog.com/entry/${song.call}" target="_blank">コール表</a>` : ''}</td>
                                            <td>${song.MVlink ? `<a href="https://www.youtube.com/watch?v=${song.MVlink}" target="_blank">MV</a>` : ''}</td>
                                            <td>${song.videolink ? `<a href="https://www.youtube.com/watch?v=${song.videolink}" target="_blank">ライブ映像</a>` : ''}</td>
                                            <td><a href="./sub/search.html?name=${song.title}">${performanceData.count}</a></td>
                                            <td><a href="./sub/setlist.html?id=${performanceData.id}">${latestPerformanceDate}</a></td>
                                            <td>${song.lyrics}</td>
                                            <td>${song.music}</td>
                                            <td>${song.arranger}</td>
                                            <td>${song.length}</td>
                                            <td>${song.CDtitle}</td>
                                            <td>${formattedDate}</td>
                                        `;
                                        songTable.appendChild(row);
                                    });
                                });
                        });
                });
        }
    </script>
</body>
</html>
