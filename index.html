<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゆいかおり楽曲一覧</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .sortable {
            cursor: pointer;
        }
        .pink-cell {
            background-color: hotpink;
        }
    </style>
</head>

<body>
    <h2>ゆいかおり楽曲一覧</h2>
    <table>
        <thead>
            <tr>
                <th>楽曲名</th>
                <th>コール表</th>
                <th>MV</th>
                <th>ライブ映像</th>
                <th class="sortable" data-column="count">披露回数</th>
                <th class="sortable" data-column="latestDate">最終披露日</th>
                <th>作詞</th>
                <th>作曲</th>
                <th>編曲</th>
                <th>長さ</th>
                <th>収録CD</th>
                <th class="sortable" data-column="releaseDate">リリース日</th>
            </tr>
        </thead>
        <tbody id="songTable"></tbody>
    </table>

    <script>
        let originalData = [];
        let sortedColumn = null;
        let ascending = true;

        function formatDateToJapanese(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString();
            const day = date.getDate().toString();
            return `${year}年${month}月${day}日`;
        }

        function parseDate(dateStr) {
            return dateStr === '未披露' || dateStr === 'No release date found' ? new Date(0) : new Date(dateStr.replace(/年|月/g, '-').replace(/日/g, ''));
        }

        function updateSongTable(songs) {
            const songTable = document.getElementById('songTable');
            songTable.innerHTML = '';
            songs.forEach(song => {
                const row = `
                    <tr>
                        <td>${song.title}</td>
                        <td>${song.callLink}</td>
                        <td>${song.MVLink}</td>
                        <td>${song.videoLink}</td>
                        <td>${song.count}</td>
                        <td>${song.latestDate}</td>
                        <td>${song.lyrics}</td>
                        <td>${song.music}</td>
                        <td>${song.arranger}</td>
                        <td>${song.length}</td>
                        <td>${song.CDtitle}</td>
                        <td>${song.releaseDate}</td>
                    </tr>
                `;
                songTable.innerHTML += row;
            });
        }

        function sortTable(column) {
            if (sortedColumn === column) {
                ascending = !ascending;
            } else {
                sortedColumn = column;
                ascending = true;
            }

            let sortedData = [...originalData];
            sortedData.sort((a, b) => {
                if (column === 'count') {
                    return ascending ? a.count - b.count : b.count - a.count;
                } else if (column === 'latestDate' || column === 'releaseDate') {
                    return ascending ? parseDate(a[column]) - parseDate(b[column]) : parseDate(b[column]) - parseDate(a[column]);
                }
                return 0;
            });
            updateSongTable(sortedData);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch('song.json')
                .then(response => response.json())
                .then(songs => {
                    fetch('CD.json')
                        .then(response => response.json())
                        .then(CDs => {
                            fetch('setlist.json')
                                .then(response => response.json())
                                .then(setlists => {
                                    originalData = songs.map(song => {
                                        const performanceData = setlists.reduce((acc, setlist) => {
                                            const date = parseDate(setlist.date);
                                            if (setlist.setlist.includes(song.title) || setlist.encore.includes(song.title) || setlist.Wencore === song.title) {
                                                acc.count += 1;
                                                if (!acc.latestDate || date > acc.latestDate) {
                                                    acc.latestDate = date;
                                                }
                                            }
                                            return acc;
                                        }, { count: 0, latestDate: null });

                                        const oldestDate = CDs.find(cd => cd.CDtitle === song.CDtitle)?.date || 'No release date found';

                                        return {
                                            title: `<a href="https://www.uta-net.com/song/${song.utanet}">${song.title}</a>`,
                                            callLink: song.call ? `<a href="https://yuicom-callbook.hatenablog.com/entry/${song.call}" target="_blank">コール表</a>` : '',
                                            MVLink: song.MVlink ? `<a href="https://www.youtube.com/watch?v=${song.MVlink}" target="_blank">MV</a>` : '',
                                            videoLink: song.videolink ? `<a href="https://www.youtube.com/watch?v=${song.videolink}" target="_blank">ライブ映像</a>` : '',
                                            count: performanceData.count,
                                            latestDate: performanceData.latestDate ? formatDateToJapanese(performanceData.latestDate) : '未披露',
                                            lyrics: song.lyrics,
                                            music: song.music,
                                            arranger: song.arranger,
                                            length: song.length,
                                            CDtitle: song.CDtitle,
                                            releaseDate: oldestDate
                                        };
                                    });
                                    updateSongTable(originalData);
                                });
                        });
                });
        });

        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.column;
                if (column === 'releaseDate') {
                    updateSongTable(originalData);
                } else {
                    sortTable(column);
                }
            });
        });
    </script>
</body>

</html>
