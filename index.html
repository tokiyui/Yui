<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゆいかおり楽曲一覧</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .sortable {
            cursor: pointer;
        }
        .pink-cell {
            background-color: hotpink;
        }
    </style>
</head>

<body>
    <h2>ゆいかおり楽曲一覧</h2>
    <table>
        <thead>
            <tr>
                <th>楽曲名</th>
                <th>コール表</th>
                <th>MV</th>
                <th>ライブ映像</th>
                <th class="sortable" data-column="count">披露回数</th>
                <th class="sortable" data-column="latestDate">最終披露日</th>
                <th>作詞</th>
                <th>作曲</th>
                <th>編曲</th>
                <th>長さ</th>
                <th>収録CD</th>
                <th class="sortable" data-column="releaseDate">リリース日</th>
            </tr>
        </thead>
        <tbody id="songTable"></tbody>
    </table>

<script>
    let defaultSongData = [];

    function updateSongDetails(selectedArtist) {
        fetch('song.json')
            .then(response => response.json())
            .then(songs => {
                fetch('CD.json')
                    .then(response => response.json())
                    .then(CDs => {
                        fetch('setlist.json')
                            .then(response => response.json())
                            .then(setlists => {
                                const songTable = document.getElementById('songTable');
                                songTable.innerHTML = ''; 
                                defaultSongData = [];

                                songs.forEach(song => {
                                    if (selectedArtist === 'yui' && song.artist !== '小倉唯') return;
                                    if (selectedArtist === 'kaori' && song.artist !== '石原夏織') return;
                                    if (selectedArtist === 'yuikaori' && song.artist !== 'ゆいかおり') return;

                                    const matchingCDs = CDs.filter(cd => song.CDtitle.includes(cd.CDtitle));
                                    const oldestDate = matchingCDs.length > 0 ? matchingCDs.reduce((oldest, current) => {
                                        return new Date(oldest.date.replace(/年|月/g, '-').replace(/日/g, '')) <
                                            new Date(current.date.replace(/年|月/g, '-').replace(/日/g, '')) ? oldest : current;
                                    }).date : 'No release date found';

                                    const performanceData = setlists.reduce((acc, setlist) => {
                                        const date = new Date(setlist.date.replace(/年|月/g, '-').replace(/日/g, ''));
                                        const songsArray = Array.isArray(setlist.setlist) ? setlist.setlist : [setlist.setlist];
                                        if (!Array.isArray(setlist.encore)) songsArray.push(setlist.encore);
                                        else songsArray.push(...setlist.encore);
                                        if (setlist.Wencore) songsArray.push(setlist.Wencore);

                                        const titles = songsArray.flatMap(title => (typeof title === 'object' && 'medley' in title) ? title.medley : title);
                                        if (titles.includes(song.title)) {
                                            acc.count += 1;
                                            if (!acc.latestDate || date > acc.latestDate) {
                                                acc.latestDate = date;
                                                acc.id = setlist.id;
                                            }
                                        }
                                        return acc;
                                    }, { count: 0, latestDate: null, id: null });

                                    const latestPerformanceDate = performanceData.latestDate ? formatDateToJapanese(performanceData.latestDate) : '未披露';

                                    const rowData = {
                                        title: song.title,
                                        call: song.call ? `<a href="https://yuicom-callbook.hatenablog.com/entry/${song.call}" target="_blank">コール表</a>` : '',
                                        mv: song.MVlink ? `<a href="https://www.youtube.com/watch?v=${song.MVlink}" target="_blank">MV</a>` : '',
                                        video: song.videolink ? `<a href="https://www.youtube.com/watch?v=${song.videolink}" target="_blank">ライブ映像</a>` : '',
                                        count: performanceData.count,
                                        lastDate: latestPerformanceDate,
                                        lyrics: song.lyrics,
                                        music: song.music,
                                        arranger: song.arranger,
                                        length: song.length,
                                        cdTitle: song.CDtitle,
                                        releaseDate: oldestDate
                                    };
                                    defaultSongData.push(rowData);
                                });
                                renderTable(defaultSongData);
                            });
                    });
            });
    }

    function renderTable(data) {
        const songTable = document.getElementById('songTable');
        songTable.innerHTML = data.map(song => `
            <tr>
                <td><a href="https://www.uta-net.com/song/${song.utanet}">${song.title}</a></td>
                <td>${song.call}</td>
                <td>${song.mv}</td>
                <td>${song.video}</td>
                <td>${song.count}</td>
                <td>${song.lastDate}</td>
                <td>${song.lyrics}</td>
                <td>${song.music}</td>
                <td>${song.arranger}</td>
                <td>${song.length}</td>
                <td>${song.cdTitle}</td>
                <td>${song.releaseDate}</td>
            </tr>
        `).join('');
    }

    function sortTable(columnIndex) {
        let sortedData = [...defaultSongData];
        const isAscending = document.getElementById("songTable").getAttribute("data-sort") !== `col${columnIndex}-asc`;
        document.getElementById("songTable").setAttribute("data-sort", isAscending ? `col${columnIndex}-asc` : `col${columnIndex}-desc`);

        if (columnIndex === 4) { // 披露回数
            sortedData.sort((a, b) => isAscending ? a.count - b.count : b.count - a.count);
        } else if (columnIndex === 5) { // 最終披露日
            sortedData.sort((a, b) => {
                if (a.lastDate === "未披露") return isAscending ? 1 : -1;
                if (b.lastDate === "未披露") return isAscending ? -1 : 1;
                return isAscending
                    ? new Date(a.lastDate.replace(/年|月/g, '-').replace(/日/g, '')) - new Date(b.lastDate.replace(/年|月/g, '-').replace(/日/g, ''))
                    : new Date(b.lastDate.replace(/年|月/g, '-').replace(/日/g, '')) - new Date(a.lastDate.replace(/年|月/g, '-').replace(/日/g, ''));
            });
        } else if (columnIndex === 11) { // リリース日（デフォルト順に戻す）
            sortedData = [...defaultSongData];
        }

        renderTable(sortedData);
    }

    document.querySelectorAll(".radio-input").forEach(filter => {
        filter.addEventListener("change", event => updateSongDetails(event.target.value));
    });

    updateSongDetails('yui');
</script>

</body>

</html>
